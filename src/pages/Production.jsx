// src/pages/Production.jsx
import React, { useEffect, useState } from "react";
import { db } from "../firebase";
import { collection, doc, getDocs, updateDoc } from "firebase/firestore";
import toast from "react-hot-toast";
import "../styles/Responsive.css";

export default function Production() {
  const [jobs, setJobs] = useState([]);
  const [selectedJobId, setSelectedJobId] = useState("");
  const [form, setForm] = useState({
    batch_no_production: "",
    production_status: "",
    remark: "",
  });
  const [showConfirm, setShowConfirm] = useState(false);

  useEffect(() => {
    fetchJobs();
  }, []);

  const fetchJobs = async () => {
    const snapshot = await getDocs(collection(db, "production_workflow"));
    const data = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
    setJobs(data.filter((job) => job.currentStep === "Production"));
  };

  const handleChange = (e) => {
    const { name, value } = e.target;
    setForm((prev) => ({ ...prev, [name]: value }));
  };

  const handleSelectJob = (e) => {
    const jobId = e.target.value;
    setSelectedJobId(jobId);
    const selectedJob = jobs.find((job) => job.id === jobId);
    const batchFromWH = selectedJob?.batch_no_warehouse?.join(", ") || "";
    setForm({
      batch_no_production: batchFromWH,
      production_status: "",
      remark: "",
    });
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!selectedJobId || !form.production_status) {
      toast.error("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
      return;
    }
    setShowConfirm(true);
  };

  const handleFinalSubmit = async () => {
    const jobRef = doc(db, "production_workflow", selectedJobId);
    const updates = {
      batch_no_production: form.batch_no_production,
      status: { production: form.production_status },
      remarks: { production: form.remark || "" },
      Timestamp_Production: new Date().toISOString(),
    };

    if (form.production_status === "‡∏£‡∏≠‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à") {
      updates.currentStep = "QC";
      updates.waiting_for = "Inspection";
    } else if (form.production_status === "‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à") {
      updates.currentStep = "QC";
      updates.waiting_for = "COA";
    } else {
      updates.currentStep = "Production";
    }

    try {
      await updateDoc(jobRef, updates);
      toast.success("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Production ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      fetchJobs();
      setSelectedJobId("");
      setForm({ batch_no_production: "", production_status: "", remark: "" });
      setShowConfirm(false);
    } catch (error) {
      console.error(error);
      toast.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
      setShowConfirm(false);
    }
  };

  return (
    <div className="page-container">
      <h2>üß™ <strong>Production - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</strong></h2>

      <form onSubmit={handleSubmit} className="form-grid">
        <div className="full-span">
          <label>üìã ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
          <select value={selectedJobId} onChange={handleSelectJob} className="input-box">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô --</option>
            {jobs.map((job) => (
              <option key={job.id} value={job.id}>
                {job.po_number || "-"} - {job.customer || "-"} - {job.product_name || "-"}
              </option>
            ))}
          </select>
        </div>

        <div>
          <label>üî¢ Batch No</label>
          <input
            type="text"
            name="batch_no_production"
            value={form.batch_no_production}
            onChange={handleChange}
            className="input-box"
            placeholder="‡∏£‡∏∞‡∏ö‡∏∏ Batch No (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
          />
        </div>

        <div>
          <label>üîÑ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</label>
          <select name="production_status" value={form.production_status} onChange={handleChange} className="input-box">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
            <option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï</option>
            <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï</option>
            <option value="‡∏£‡∏≠‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à">‡∏£‡∏≠‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</option>
            <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏</option>
            <option value="‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à">‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à</option>
          </select>
        </div>

        <div className="full-span">
          <label>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <input
            type="text"
            name="remark"
            value={form.remark}
            onChange={handleChange}
            className="input-box"
            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏≤‡∏Å‡∏°‡∏µ"
          />
        </div>

        <button type="submit" className="submit-btn full-span">
          ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Production
        </button>
      </form>

      {showConfirm && (
        <div className="overlay" onClick={() => setShowConfirm(false)}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <h3>üìã ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
            <ul>
              {form.batch_no_production && <li><strong>Batch No:</strong> {form.batch_no_production}</li>}
              <li><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï:</strong> {form.production_status}</li>
              {form.remark && <li><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> {form.remark}</li>}
            </ul>
            <div className="button-row">
              <button className="submit-btn" onClick={handleFinalSubmit}>‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              <button className="cancel-btn" onClick={() => setShowConfirm(false)}>‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
